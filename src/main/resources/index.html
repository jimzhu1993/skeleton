<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="./style.css"/>
    <script data-require="jquery@*" data-semver="3.1.1" src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <style>
        body {
            font-family: 'Arial';
            line-height: 20px;
        }
        H1 {
            float: left;
        }
        #heading{
            /*2px border 60+2 */
            height:62px;
            width:500px;
        }
        #container {
            border: 2px solid black;
            background-color: #ff9828;
            width:500px;
        }
        #mainBox{
            /*border: 1px solid black;*/
        }
        #receiptTable{
            margin-top: 10px;
            width:500px;
            /*border: 1px solid blue;*/
        }
        .button{
            border-radius: 20px;
            background-color: #6a9ee7;
            border: 2px solid #000000;
            width: 100px;
            height: 50px;
            float: right;
            font-size: 2em;
            color: white;
            text-align: center;
        }
        .textInputBox{
            background-color: #ff9828;
            border: 2px solid black;
            height: 50px;
            width: 400px;
            font-size: 2em;
            color: white;
        }
        #addButton{
            border-radius: 30px;
            background-color: #6a9ee7;
            border: 2px solid #000000;
            width: 100px;
            height:30px;
            float: right;
            font-size: 1em;
            color: white;
            text-align: center;
        }
        #cancel-receipt{
            background-color: #e26466;
            border: 2px solid #000000;
            border-radius: 10px;
            width: 160px;
            height:60px;
            font-size: 2em;
            color: white;
            text-align: center;
            margin-left: 150px;

        }
        #save-receipt{
            background-color: #66a858;
            border: 2px solid #000000;
            border-radius: 10px;
            width: 160px;
            height:60px;
            font-size: 2em;
            color: white;
            text-align: center;
            margin-left: 10px;
        }
        #add-receipt {
            background-color: #ff9828;
            border: 2px solid #000000;
            border-radius: 10px;
            width: 160px;
            height: 60px;
            font-size: 4em;
            color: white;
            text-align: center;
            vertical-align: middle;
            line-height: 60px;
        }
        #receiptList {
            clear: both;
        }
        .receipt-header {
            background-color: #cee2f2;
            border-bottom: 2px solid black;
            width: 500px;
        }
        .receipt {
            background-color: #cee2f2;
            /*padding-top: 10px;*/
            /*padding-bottom: 10px;*/
            /*margin-bottom: 8px;*/
            /*margin-bottom: 8px;*/
            font-size: 15px;
            width: 500px;
            height: 100px;
        }
        /*tags looks nicer if made in this way*/
        /*.receipt span{*/
            /*border-right: 2px solid black;*/
            /*width: 110px;*/
            /*display: inline-block;*/
            /*text-align: center;*/
            /*padding: 4px;*/
            /*!*margin: auto;*!*/
        /*}*/
        #addReceiptDialogue{
            /*background-color: #ff9828;*/
            text-align: center;
            vertical-align: middle;
            line-height: 60px;
        }
        .tagValue {
            border-radius: 30px;
            margin-left: 10px;
            height:50px;
            /*float: right;*/
            border: 2px solid #000000;
            font-size: 1em;
            text-align: center;
            color: #000000;
            background-color: #e9ddbd;
        }
    </style>
    <script>
        const api = "";
        $(refreshReceipts())

        function addTag(input) {
            var flag = false
            input.parentNode.childNodes.forEach(
                function(child){
                    if (child.type == "text") {
                        child.parentNode.removeChild(child)
                        flag = true
                        return
                    }
                })

            if (flag) { return }

            var text = document.createElement('input')
            text.name = input.name
            text.className = "tag_input"
            text.type = "text"
            text.placeholder = "Add Tag"

            text.addEventListener('keypress', function(event){
                if (event.keyCode == 13)
                {
//                    the same tag has been inserted before and has not been removed
//                    for (var i = 0; i < text.parentNode.getElementsByClassName("tagValue").length; i++) {
//                        if(text.parentNode.getElementsByClassName("tagValue")[i].text == text.value)
//                            return
//                    }
                    $.ajax(
                        {
                            type: "PUT",
                            contentType: "application/json; charset=utf-8",
                            url: api + "/tags/" + text.value,
                            dataType: "json",
                            data: JSON.stringify(parseInt(text.name)),
                            success: function(){
                                refreshReceipts();
                            },
                        }
                    );
                }
            });
            document.getElementById(input.name).appendChild(text)
        }
        function refreshReceipts() {
            // This is the idiomatic way to ensure that JQuery does not
            // execute until the page has loaded
            $.getJSON(api + "/receipts", function(receipts){
                $("#receiptList").empty();
                for(var idx = receipts.length - 1; idx >= 0; idx--) {
                    var receipt = receipts[idx];
                    $(`<div class="receipt">
                            <div>Time: <span class = "time">${receipt.created}</span><br></div>
                            <div>Name: <span class = "merchant">${receipt.merchantName}</span><br></div>
                            <div>Amount: <span class = "amount">${receipt.value}</span><br></div>
                            <div>Tags:
                            <span class="tags" id = ${receipt.id}>
                                <input id = "addButton"type="button" class = "add-tag" name = ${receipt.id} value="Add +" onclick="addTag(this)">
                            </span><br></div>
                        </div>`
                    ).appendTo($("#receiptList"));

                    receipt.tags.forEach(function(tag) {
                        var tagButton = document.createElement('a');
                        tagButton.className = "tagValue"
                        tagButton.name = receipt.id
                        tagButton.text = tag
                        tagButton.addEventListener('click', function(){
                            toggleTag(tag, this)
                        });
                        document.getElementById(receipt.id).appendChild(tagButton)
                    });
                }
            })
        }

        function addReceipt() {
            $.ajax(
                {
                url:api+"/receipts",
                type:"POST",
                data:JSON.stringify(
                    {
                        merchant: $("#merchant").val(),
                        amount: Number($("#amount").val())
                    }
                ),
                    dataType:    "json",
                    contentType: "application/json;  charset=utf-8",
//                    load recepits on success adding by sync front-back
                    success: function(){
                        refreshReceipts();
                    },
                }
            );
        }

        function toggleTag(tag, input) {
            $.ajax(
                {
                    type: "PUT",
                    contentType: "application/json; charset=utf-8",
                    url: api + "/tags/" + tag,
                    dataType: "json",
                    data: JSON.stringify(parseInt(input.name)),
//                    load tag on success adding by sync front-back
                    success: function(){
                        refreshReceipts();
                    },
                }
            );
        }

        function toggleAddReceiptDialogue() {
            block = document
                .getElementById("addReceiptDialogue")
                .firstChild
            if (block == null) {
                $(`<div id = container>
                  <p><input class = "textInputBox" type="text" id="merchant" placeholder="merchant"></p>
                  <p><input class = "textInputBox" type="text" id="amount" placeholder="amount"></p>
                  <div><input type="button" id="cancel-receipt" value="Cancel" onclick = "toggleAddReceiptDialogue()">
                  <input type="button" id="save-receipt" value="Save" onclick = "addReceipt()"></div></div>`)
                .appendTo($("#addReceiptDialogue"))
            } else {block.parentNode.removeChild(block)}}
    </script>
</head>
<body>
<h1>My Receipts</h1>
<DIV id="heading">
    <!--firstBlock-->
    <div class="button" id = "add-receipt" onclick = "toggleAddReceiptDialogue()">+</div>
</DIV>
<DIV id="mainBox">
    <!--secondBlock-->
    <div id = "addReceiptDialogue"></div>
</DIV>
    <!--thirdBlock-->
<DIV id="receiptTable">
    <div id="receiptList"></div>
</DIV>
</body>
</html>